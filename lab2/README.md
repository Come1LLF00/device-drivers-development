# Лабораторная работа 2

**Название:** "Разработка драйверов блочных устройств"

**Цель работы:** получить знания и навыки разработки драйверов блочных устройств для операционной системы Linux.

---

## Описание функциональности драйвера

* Драйвер создает виртуальный жесткий диск на 50 Мб в RAM со следующей таблицей разделов:

| Файл.система  | Размер        | Вид раздела |
| ------------- | ------------- | ----------- |
| /dev/mydisk1  | 10M           | первичный   |
| /dev/mydisk2  | 20M           | первичный   |
| /dev/mydisk3  | 20M           | расширенный |

```
Устр-во          Загрузочный начало Конец  Секторы Размер Идентификатор Тип
/dev/ramvdisk1                    1  20479   20479    10M            83 Linux                            
/dev/ramvdisk2                20480  61438   40959    20M            83 Linux
/dev/ramvdisk3                61440 102399   40960    20M             5 Расширенный
├─/dev/ramvdisk5              61441  81919   20479    10M            83 Linux
└─/dev/ramvdisk6              81921 102399   20479    10M            83 Linux
```

* Ведется подсчет числа пользователей, которые используют диск ( `cb: open` ), так что все попытки выгрузить модуль, пока хотя бы 1 процесс его использует, пресекаются
* Модуль точно работает под ядром Linux `5.11.0-38-generic` и использует добавленный в ядро 4.12 механизм `blk-mq` ( иначе он бы не заработал, так как соответствующие функции были удалены )
* Драйвер поддерживает функции записи на диск и чтения с него

## Инструкция по сборке

### Сборка

```
make # собрать модуль
make do # слинковать модуль с ядром
make vfat DPART=<путь до партиции> # форматирует раздел под ФС FAT 16 
# работать с диском mount и т.д., перед этим не забыв создать файловую систему
```

### Разборка

```
# прекратить все операции с диском umount там и т.д.
make rm # выгрузить модуль
make clean # (опционально) чтобы не держать собранные пакеты
```

## Инструкция пользователя

1. Собрать драйвер и загрузить в ядро ( [см. Инструкцию по сборке](#инструкция-по-сборке) )
2. Создать файловую систему для нужных разделов ( `sudo mkfs.vfat <нужный раздел>` )
3. Смонтировать раздел в папку ( `sudo mount -t vfat <раздел> <в нужный каталог>` )
4. Всё. Можно свободно пользоваться диском.

## Примеры использования

```
make vfat DPART=/dev/ramvdisk1
sudo mkdir /mnt/ramvdisk1
sudo mount -t vfat /dev/ramvdisk1 /mnt/ramvdisk1
echo "Hello, Virtual Disk in RAM!" > ./hello
sudo cp ./hello /mnt/ramvdisk1/hello
ls -l /mnt/ramvdisk1
cat /mnt/ramvdisk1/hello
sudo umount /mnt/ramvdisk1
---
итого 2
-rwxr-xr-x 1 root root 28 апр  5 22:42 hello
Hello, Virtual Disk in RAM!
```

### Измерение скорости передачи данных

`sudo dd if=<source part.> of=<destination part.> count=<number of input blocks>`

#### Передача между разделами виртуального жесткого диска

Между первичными
```
sudo dd if=/dev/ramvdisk1 of=/dev/ramvdisk2 count=10k
10240+0 записей получено
10240+0 записей отправлено
5242880 байт (5,2 MB, 5,0 MiB) скопирован, 0,0608861 s, 86,1 MB/s
```

Между первичным и расширенным
```
sudo dd if=/dev/ramvdisk1 of=/dev/ramvdisk5 count=10k
10240+0 записей получено
10240+0 записей отправлено
5242880 байт (5,2 MB, 5,0 MiB) скопирован, 0,0592045 s, 88,6 MB/s
```

Между логическими разделами расширенного раздела
```
sudo dd if=/dev/ramvdisk5 of=/dev/ramvdisk6 count=10k
10240+0 записей получено
10240+0 записей отправлено
5242880 байт (5,2 MB, 5,0 MiB) скопирован, 0,0663528 s, 79,0 MB/s
```

#### Передача между виртуальным и реальным жестким диском

```
sudo dd if=/dev/sda1 of=/dev/ramvdisk1 count=10k
10240+0 записей получено
10240+0 записей отправлено
5242880 байт (5,2 MB, 5,0 MiB) скопирован, 0,0581674 s, 90,1 MB/s
```